# 2023-02-04

MAIN GOAL: Plan out tasks and goals for today's work

## Moving MIDI event scheduling to the audio thread

We want to avoid the random delay that comes from round-tripping MIDI events from the audio thread -> UI thread -> audio thread when dealing with the scheduler.

In order to do this, we will add an opt-in ability for scheduling to send MIDI events to mailboxes on the audio thread directly.  Right now, I only want to do this with the synth designer.  I looked into it yesterday, and I don't think this will be too difficult for the synth designer tbh.  The gate function for the synth designer basically just calls two methods that send messages to the audio thread as it is.

There are some hurdles we'll have to get past in order to make this work.  One worry I have is that the scheduler node will not run before the other nodes, which will cause up to a frame of delay during scheduling.  This probably isn't even worth thinking about right now, though.

### PolySynth context

Something I forgot about.  We use that polysynth context to handle voice scheduling.  We will need to move that to the audio thread as well in order to make this work, since the current polysynth state lives in the UI thread.

We'll need to update that module to remove the wasm-bindgen stuff since that doesn't work in AWPs, and then make some changes to get it loaded in the audio thread.

## Scheduling/Mailbox Design

All global state is shared between different `AudioWorkletProcessor`s on the audio thread.  So, we should be able to just set in a global there that holds mailboxes for all opted-in nodes and write/read from those directly.

I'd like to avoid allocation for this, so I think that doing some kind of ring buffer structure will be good.  We can write MIDI events into the buffer along with what samples they will occur on, and then when they're consumed we just increment the index or whatever.

## Indicating Opt-In Intent

Probably want to do it at the MIDI node level.  We can set some kind of flag on the MIDI node that says "yeah we'll consume these events on the audio thread directly" and in that case, the sender can choose to send them that way instead.

## Follow-Up Work

I want to update MIDI editor scheduling to avoid the delay when starting.  If global playback is started and the MIDI editor has a note scheduled at beat 0, it won't be picked up by envelope generators etc. until like beat 0.05.  Want to eliminate that delay somehow if possible.  Probably will have to do scheduling ahead of time before the global beat counter is started, or register a callback that fires before it actually starts or something.
